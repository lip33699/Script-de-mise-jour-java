
# ================= Java preparation for Control-M 9.0.21.x =================
# Ensures Java 11/17 is present and sets BMC_INST_JAVA_HOME.
# Linux: tries dnf/yum to install OpenJDK if missing.
# AIX: uses /usr/java11_64 or optional AIX_JAVA_FILES_DIR with installp images.
ensure_java() {
  CTM_JAVA_VERSION="${CTM_JAVA_VERSION:-11}"
  case "$(uname -s)" in
    Linux) ensure_java_linux ;;
    AIX)   ensure_java_aix ;;
    *)     echo "OS non supporté pour l'installation automatique de Java." >&2 ;;
  esac
}

ensure_java_linux() {
  if [ -n "${BMC_INST_JAVA_HOME}" ] && [ -x "${BMC_INST_JAVA_HOME}/bin/java" ]; then :; else
    for J in /usr/lib/jvm/java-${CTM_JAVA_VERSION}-openjdk* /usr/lib/jvm/temurin-${CTM_JAVA_VERSION}-jre* /usr/lib/jvm/temurin-${CTM_JAVA_VERSION}-jdk* ; do
      [ -x "$J/bin/java" ] && export BMC_INST_JAVA_HOME="$J" && break
    done
  fi
  if [ ! -x "${BMC_INST_JAVA_HOME}/bin/java" ]; then
    if command -v dnf >/dev/null 2>&1 ; then
      sudo dnf install -y "java-${CTM_JAVA_VERSION}-openjdk-headless" || sudo dnf install -y "java-${CTM_JAVA_VERSION}-openjdk"
    elif command -v yum >/dev/null 2>&1 ; then
      sudo yum install -y "java-${CTM_JAVA_VERSION}-openjdk-headless" || sudo yum install -y "java-${CTM_JAVA_VERSION}-openjdk"
    else
      echo "Installez Java ${CTM_JAVA_VERSION} manuellement (ni dnf ni yum)." >&2
    fi
    if command -v java >/dev/null 2>&1 ; then
      JAVABIN="$(command -v java)"
      REALBIN="$(readlink -f "$JAVABIN" 2>/dev/null || echo "$JAVABIN")"
      export BMC_INST_JAVA_HOME="$(dirname "$(dirname "$REALBIN")")"
    fi
  fi
  if [ ! -x "${BMC_INST_JAVA_HOME}/bin/java" ]; then
    echo "ERREUR: Java introuvable. Définissez BMC_INST_JAVA_HOME." >&2; exit 1
  fi
  "${BMC_INST_JAVA_HOME}/bin/java" -version 2>&1 | grep -E 'version "1?1\.|version "17\.' >/dev/null || { echo "ERREUR: Java 11/17 requis."; exit 1; }
  echo "OK Java Linux: $BMC_INST_JAVA_HOME"
}

ensure_java_aix() {
  if [ -z "${BMC_INST_JAVA_HOME}" ] || [ ! -x "${BMC_INST_JAVA_HOME}/bin/java" ]; then
    [ -x /usr/java11_64/bin/java ] && export BMC_INST_JAVA_HOME="/usr/java11_64"
  fi
  if [ ! -x "${BMC_INST_JAVA_HOME}/bin/java" ] && [ -n "${AIX_JAVA_FILES_DIR}" ]; then
    if command -v installp >/dev/null 2>&1 ; then
      echo "Installation Java 11 via installp depuis ${AIX_JAVA_FILES_DIR} ..."
      sudo installp -aY -d "${AIX_JAVA_FILES_DIR}" all || true
    fi
    [ -x /usr/java11_64/bin/java ] && export BMC_INST_JAVA_HOME="/usr/java11_64"
  fi
  if [ ! -x "${BMC_INST_JAVA_HOME}/bin/java" ]; then
    echo "ERREUR: Java 11 non disponible sur AIX. Installez IBM Semeru (Java 11)." >&2; exit 1
  fi
  "${BMC_INST_JAVA_HOME}/bin/java" -version 2>&1 | grep 'version "11\.' >/dev/null || { echo "ERREUR: AIX requiert Java 11."; exit 1; }
  echo "OK Java AIX: $BMC_INST_JAVA_HOME"
}
# ==========================================================================
# cat exploitcontrolm.ksh
#!/bin/ksh

###########################################################
# INFO : SCRIPT D'EXPLOITATION CONTROL-M
# POUR : CREDIT AGRICOLE
# PAR  : Adams Ngono
###########################################################
# 2025.03.09 : Adams N - Creation
# 2023 07 13 : Adams N - Update ProductVersion 9.0.21.300
###########################################################

# VARIABLE GLOBAL
###########################################################

export PATH=/bin:/usr/bin:/usr/sbin:/tools/admin/bin
ProductVersion="${CTM_VERSION:-9.0.21.300}"
Repository="/softwares/PRODUITS/CONTROLM"
OS=$1
OPT=$2
Envir=$3
OSuname=$(uname)
OSlevel=$(oslevel)

#- Fonctions -##############################################

function Envir
{
case $Envir in
              HP|PR) ;;
                  *) echo "Parametre Envir invalide : $4"
                     echo "Autorisation pour : HP|PR"
                     echo "Abandon..."
                     exit 1 ;;
esac
}

function nimmount
{
    echo "-> Montage du serveur NIM"

    /tools/admin/bin/mountnim
}

function nimunmount
{
    echo "-> Demontage du serveur NIM"

    /tools/admin/bin/umountnim
}

# GESTION AIX
###########################################################

function installaixstandalone
{

    echo "-> Installation Control-M Agent AIX vers ${ProductVersion} (standalone)"
    ensure_java
    export PATH=$PATH:$HOME/bin:/tools/admin/local/bin:/tools/admin/bin:/tools/admin/san:/usr/local/bin:/sbin
    REPO_VER="${Repository}/V${ProductVersion}/AGENT"
    PARAM_XML="${REPO_VER}/agent_params.xml"
    if [ -x "${REPO_VER}/AIX/setup.sh" ] && [ -f "${PARAM_XML}" ]; then
        echo "-> Utilisation du média versionné: ${REPO_VER}"
        "${REPO_VER}/AIX/setup.sh" -silent "${PARAM_XML}" -BMC_INST_JAVA_HOME "${BMC_INST_JAVA_HOME}"
    else
        echo "-> Média versionné introuvable, fallback vers wrapper legacy Install_Aix_CTMAGT.ksh"
        BMC_INST_JAVA_HOME="${BMC_INST_JAVA_HOME}" "${Repository}/AixInstall/Install_Aix_CTMAGT.ksh" -e "${Envir}"
    fi

}

function installaixclusteractif
{

    echo "-> Installation Control-M Agent AIX ${ProductVersion} (cluster ACTIF)"
    ensure_java
    export PATH=$PATH:$HOME/bin:/tools/admin/local/bin:/tools/admin/bin:/tools/admin/san:/usr/local/bin:/sbin
    REPO_VER="${Repository}/V${ProductVersion}/AGENT"
    PARAM_XML="${REPO_VER}/agent_params.xml"
    if [ -x "${REPO_VER}/AIX/setup.sh" ] && [ -f "${PARAM_XML}" ]; then
        echo "-> Utilisation du média versionné: ${REPO_VER}"
        "${REPO_VER}/AIX/setup.sh" -silent "${PARAM_XML}" -BMC_INST_JAVA_HOME "${BMC_INST_JAVA_HOME}"
        echo "-> Pensez à appliquer la config cluster (script post-install interne)"
    else
        echo "-> Média versionné introuvable, fallback vers wrapper legacy Install_Aix_CTMAGT_Cluster_ACTIF.ksh"
        BMC_INST_JAVA_HOME="${BMC_INST_JAVA_HOME}" "${Repository}/AixInstall/Install_Aix_CTMAGT_Cluster_ACTIF.ksh" -e "${Envir}"
    fi

}

function installaixclusterpassif
{

    echo "-> Installation Control-M Agent AIX ${ProductVersion} (cluster PASSIF)"
    ensure_java
    export PATH=$PATH:$HOME/bin:/tools/admin/local/bin:/tools/admin/bin:/tools/admin/san:/usr/local/bin:/sbin
    REPO_VER="${Repository}/V${ProductVersion}/AGENT"
    PARAM_XML="${REPO_VER}/agent_params.xml"
    if [ -x "${REPO_VER}/AIX/setup.sh" ] && [ -f "${PARAM_XML}" ]; then
        echo "-> Utilisation du média versionné: ${REPO_VER}"
        "${REPO_VER}/AIX/setup.sh" -silent "${PARAM_XML}" -BMC_INST_JAVA_HOME "${BMC_INST_JAVA_HOME}"
        echo "-> Pensez à appliquer la config cluster (script post-install interne)"
    else
        echo "-> Média versionné introuvable, fallback vers wrapper legacy Install_Aix_CTMAGT_Cluster_PASSIF.ksh"
        BMC_INST_JAVA_HOME="${BMC_INST_JAVA_HOME}" "${Repository}/AixInstall/Install_Aix_CTMAGT_Cluster_PASSIF.ksh" -e "${Envir}"
    fi

}

function upgradeagentaix
{
    echo "-> Upgrade Control-M Agent AIX vers ${ProductVersion}"
    ensure_java
    export PATH=$PATH:$HOME/bin:/tools/admin/local/bin:/tools/admin/bin:/tools/admin/san:/usr/local/bin:/sbin
    cd /tools/list/ctmagent/ctmagt
    PARAM_XML="${Repository}/V${ProductVersion}/AGENT/agent_params.xml"
    ${Repository}/V${ProductVersion}/AGENT/AIX/setup.sh \
        -silent "${PARAM_XML}" \
        -BMC_INST_JAVA_HOME "${BMC_INST_JAVA_HOME}"
}
function StartctmagtAix
{
    echo "-> Start Control-M Agent AIX"
    /tools/list/ctmagent/ctmagt/ctm/scripts/start-ag -u ctmagt -p all
    chmod 644 /tools/list/ctmagent/ctmagt/ctm/proclog/start_ag*
    chmod -R 755 /tools/list/ctmagent/ctmagt/ctm/proclog/LogsZip
    chmod -R 755 /tools/list/ctmagent/ctmagt/ctm/proclog/Metrics
}

function StopctmagtAix
{
    echo "-> Stop Control-M Agent AIX"
    /tools/list/ctmagent/ctmagt/ctm/scripts/shut-ag -u ctmagt -p all
}

function uninstallCTMAix
{
    echo "-> desinstallation de Control-M sur AIX"

    export PATH=$PATH:$HOME/bin:/tools/admin/local/bin:/tools/admin/bin:/tools/admin/san:/usr/local/bin:/sbin
    ${Repository}/AixInstall/CTMuninstall.ksh
}

# GESTION LINUX
###########################################################

function installlinuxstandalone
{

    echo "-> Installation Control-M Agent LINUX vers ${ProductVersion} (standalone)"
    ensure_java
    export PATH=$PATH:$HOME/bin:/tools/admin/local/bin:/tools/admin/bin:/tools/admin/san:/usr/local/bin:/sbin
    REPO_VER="${Repository}/V${ProductVersion}/AGENT"
    PARAM_XML="${REPO_VER}/agent_params.xml"
    if [ -x "${REPO_VER}/Linux/setup.sh" ] && [ -f "${PARAM_XML}" ]; then
        echo "-> Utilisation du média versionné: ${REPO_VER}"
        "${REPO_VER}/Linux/setup.sh" -silent "${PARAM_XML}" -BMC_INST_JAVA_HOME "${BMC_INST_JAVA_HOME}"
    else
        echo "-> Média versionné introuvable, fallback vers wrapper legacy Install_Linux_CTMAGT.ksh"
        BMC_INST_JAVA_HOME="${BMC_INST_JAVA_HOME}" "${Repository}/LinuxInstall/Install_Linux_CTMAGT.ksh" -e "${Envir}"
    fi

}

function upgradeagentlinux
{
    echo "-> Upgrade Control-M Agent LINUX vers ${ProductVersion}"
    ensure_java
    export PATH=$PATH:$HOME/bin:/tools/admin/local/bin:/tools/admin/bin:/tools/admin/san:/usr/local/bin:/sbin
    cd /tools/list/ctmagent/ctmagt
    PARAM_XML="${Repository}/V${ProductVersion}/AGENT/agent_params.xml"
    ${Repository}/V${ProductVersion}/AGENT/Linux/setup.sh \
        -silent "${PARAM_XML}" \
        -BMC_INST_JAVA_HOME "${BMC_INST_JAVA_HOME}"
}

function uninstallCTMLinux
{
    echo "-> desinstallation de Control-M sur LINUX"
    export PATH=$PATH:$HOME/bin:/tools/admin/local/bin:/tools/admin/bin:/tools/admin/san:/usr/local/bin:/sbin
    ${Repository}/LinuxInstall/CTMuninstall.ksh
}

function StartctmagtLinux
{
   CheckSystemd=$(command -v systemctl >/dev/null 2>&1 && echo yes || echo no)
   if [[ ${CheckVersion} < 7 ]] ; then
    echo "-> Start Control-M Agent LINUX without use systemctl..."
    /tools/list/ctmagent/ctmagt/ctm/scripts/start-ag -u ctmagt -p all
   else
    echo "-> Start Control-M Agent LINUX with systemctl..."
    systemctl start ctmagent.service
   fi
   chmod 644 /tools/list/ctmagent/ctmagt/ctm/proclog/start_ag*
   chmod -R 755 /tools/list/ctmagent/ctmagt/ctm/proclog/LogsZip
   chmod -R 755 /tools/list/ctmagent/ctmagt/ctm/proclog/Metrics
}

function StopctmagtLinux
{
   CheckSystemd=$(command -v systemctl >/dev/null 2>&1 && echo yes || echo no)
   if [[ ${CheckVersion} < 7 ]] ; then
    echo "-> Stop Control-M Agent LINUX without use systemctl..."
    /tools/list/ctmagent/ctmagt/ctm/scripts/shut-ag -u ctmagt -p all
   else
    echo "-> Stop Control-M Agent LINUX with systemctl..."
    systemctl stop ctmagent.service
   fi
}

function StartctmemLinux
{
   echo "-> Start Control-M EM LINUX with systemctl..."
   systemctl start ctmem.service
}

function StopctmemLinux
{
   echo "-> Stop Control-M EM LINUX with systemctl..."
   systemctl stop ctmem.service
}

function StartctmserverLinux
{
   echo "-> Start Control-M Server LINUX with systemctl..."
   systemctl start ctmserver.service
}

function StopctmserverLinux
{
   echo "-> Stop Control-M Server LINUX with systemctl..."
   systemctl stop ctmserver.service
}

function StartctmcaLinux
{
   echo "-> Start Control-M Serverr-CA LINUX with systemctl..."
   systemctl start ctmca.service
}

function StopctmcaLinux
{
   echo "-> Stop Control-M Server-CA LINUX with systemctl..."
   systemctl stop ctmca.service
}

# AUTRE
###########################################################

function usage
{
    clear
    echo
    echo "Usage : exploitcontrolm.ksh [AIX]   [INSTALLSTANDALONE|INSTALLCLUSTERACTIF|INSTALLCLUSTERPASSIF] [HP|PR]"
    echo "                            [LINUX] [INSTALLSTANDALONE]                                          [HP|PR]"
    echo
    echo "                            [AIX]   [UPDGRADEAGENT]"
    echo "                            [LINUX] [UPDGRADEAGENT]"
    echo
    echo "                            [AIX]   [STARTCTMAGTAIX|STOPCTMAGTAIX]"
    echo "                            [LINUX] [STARTCTMAGTLINUX|STOPCTMAGTLINUX]"
    echo
    echo "                            [AIX]   [UNINSTALLCTMAIX]"
    echo "                            [LINUX] [UNINSTALLCTMLINUX]"
    echo
    echo "                            [LINUX] [STARTCTMEM|STOPCTMEM]"
    echo
    echo "                            [LINUX] [STARTCTMSERVER|STOPCTMSERVER]"
    echo "                            [LINUX] [STARTCTMCA|STOPCTMCA]"
    echo
    echo "                            [AUTRE] [MOUNTNIM|UMOUNTNIM"
}

case $OS in

    AIX)
        echo "OS         : ${OSuname}"
        echo "OS version : ${OSlevel}"
        echo ${OSuname} | grep -i AIX > /dev/null
        RC=${?}
        if [[ ${RC} != 0 ]] ; then
         echo "################################################"
         echo "ABORTED TOOLS :                                 "
         echo "Selected COMMAND is not for this OS : ${OSuname}"
         echo "################################################"
         exit 1
        fi
        case $OPT in
            INSTALLSTANDALONE)
                Envir
                nimmount
                installaixstandalone
                nimunmount
                ;;
            INSTALLCLUSTERACTIF)
                Envir
                nimmount
                installaixclusteractif
                nimunmount
                ;;
            INSTALLCLUSTERPASSIF)
                Envir
                nimmount
                installaixclusterpassif
                nimunmount
                ;;
            UPDGRADEAGENT)
                nimmount
                upgradeagentaix
                nimunmount
                ;;
            STARTCTMAGTAIX)
                StartctmagtAix
                ;;
            STOPCTMAGTAIX)
                StopctmagtAix
                ;;
            UNINSTALLCTMAIX)
                nimmount
                uninstallCTMAix
                nimunmount
                ;;
            *)
                usage
                ;;
        esac
        ;;


    LINUX)
        echo "OS         : ${OSuname}"
        echo "OS version : ${OSlevel}"
        echo ${OSuname} | grep -i LINUX > /dev/null
        RC=${?}
        if [[ ${RC} != 0 ]] ; then
         echo "################################################"
         echo "ABORTED TOOLS :                                 "
         echo "Selected COMMAND is not for this OS : ${OSuname}"
         echo "################################################"
         exit 1
        fi
        case $OPT in
            INSTALLSTANDALONE)
                Envir
                nimmount
                installlinuxstandalone
                nimunmount
                ;;
            UPDGRADEAGENT)
                nimmount
                upgradeagentlinux
                nimunmount
                ;;
            STARTCTMAGTLINUX)
                StartctmagtLinux
                ;;
            STOPCTMAGTLINUX)
                StopctmagtLinux
                ;;
            UNINSTALLCTMLINUX)
                nimmount
                uninstallCTMLinux
                nimunmount
                ;;
            STARTCTMEM)
                StartctmemLinux
                ;;
            STOPCTMEM)
                StopctmemLinux
                ;;
            STARTCTMSERVER)
                StartctmserverLinux
                ;;
            STOPCTMSERVER)
                StopctmserverLinux
                ;;
            STARTCTMCA)
                StartctmcaLinux
                ;;
            STOPCTMCA)
                StopctmcaLinux
                ;;
            *)
                usage
                ;;
        esac
        ;;


    AUTRE)
        case $OPT in
            MOUNTNIM)
                nimmount
                ;;
            UMOUNTNIM)
                nimunmount
                ;;
            *)
                usage
                ;;
        esac
        ;;


    *)
        usage
        ;;

esac

exit 0